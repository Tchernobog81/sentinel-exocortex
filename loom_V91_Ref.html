<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>THE LOOM : EXOCORTEX v91 (Chronos)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;800&family=Inter:wght@300;400;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root { --bg: #010102; --accent: #fbbf24; }
        html, body { 
            margin: 0 !important; padding: 0 !important; 
            width: 100vw !important; height: 100dvh !important; 
            background-color: var(--bg) !important; overflow: hidden !important;
            position: fixed; inset: 0; font-family: 'JetBrains Mono', monospace;
            touch-action: none; user-select: none; color: white;
        }
        #viewport { position: absolute; inset: 0; display: flex; flex-direction: column; width: 100%; height: 100%; }
        
        header { 
            position: absolute; top: 0; left: 0; width: 100%; height: 50px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.8) 100%);
            border-bottom: 1px solid rgba(255,255,255,0.05);
            display: flex; justify-content: space-between; align-items: center; 
            padding: 0 1rem; z-index: 1000; pointer-events: none;
        }
        .hud-element { pointer-events: auto; }
        .canvas-container { flex: 1; position: relative; width: 100%; height: 100%; overflow: hidden; z-index: 1; }
        canvas { width: 100% !important; height: 100% !important; display: block; }
        
        #sync-console {
            position: fixed; top: 60px; right: 20px; width: 340px;
            background: rgba(5, 5, 10, 0.98); border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(30px); z-index: 6000; padding: 1.5rem; 
            display: none; flex-direction: column; border-radius: 4px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        #status-msg { margin-top: 10px; padding: 10px; font-size: 10px; border-radius: 4px; display: none; font-weight: bold; }
        .status-error { background: rgba(239, 68, 68, 0.2); border: 1px solid #ef4444; color: #ef4444; }
        .status-success { background: rgba(16, 185, 129, 0.2); border: 1px solid #10b981; color: #10b981; }
        .status-info { background: rgba(59, 130, 246, 0.2); border: 1px solid #3b82f6; color: #3b82f6; }

        #loading-overlay {
            position: fixed; inset: 0; background: #000; z-index: 9000; display: flex; 
            align-items: center; justify-content: center; font-size: 12px; color: #666; pointer-events: none;
            transition: opacity 0.5s ease;
        }
        
        .cyber-icon-frame { border: 1px solid var(--accent); background: #111; overflow: hidden; }
        #label-float { 
            position: fixed; pointer-events: none; background: rgba(0,0,0,0.95); border: 1px solid var(--accent); 
            color: #fff; padding: 6px 12px; font-size: 11px; font-weight: 700; border-radius: 2px; 
            z-index: 4000; display: none; align-items: center; gap: 10px;
        }
        .detail-modal { background: rgba(4, 4, 6, 0.98); backdrop-filter: blur(50px); border: 1px solid rgba(255,255,255,0.1); z-index: 5000; }
    </style>
</head>
<body>

    <div id="loading-overlay">SYST√àME CHRONOS : INITIALISATION...</div>

    <div id="viewport">
        <header>
            <h1 class="text-[10px] font-black tracking-[0.3em] uppercase text-zinc-500 italic">The Loom <span class="text-amber-500 font-bold">v91</span></h1>
            <div class="flex gap-4">
                <button onclick="resetToModern()" class="hud-element text-zinc-500 text-[9px] hover:text-white uppercase font-black transition-all">Reset (1960-2040)</button>
                <button onclick="toggleSyncConsole()" class="hud-element px-3 py-1.5 bg-amber-500/10 text-amber-500 text-[9px] font-black border border-amber-500/30 uppercase rounded-sm hover:bg-amber-500 hover:text-black transition-all">Data Inject</button>
            </div>
        </header>

        <main class="canvas-container" onclick="closeAll()">
            <canvas id="loomChart"></canvas>
        </main>
    </div>

    <div id="sync-console">
        <h3 class="text-[10px] font-black text-amber-500 uppercase mb-4 text-left">// Data Injection</h3>
        <div class="space-y-4">
            <textarea id="json-paste" placeholder="Colle le JSON ici..." class="w-full h-40 bg-black/50 border border-white/10 text-amber-200/70 p-3 font-mono text-[10px] outline-none resize-none focus:border-amber-500/50 transition-colors"></textarea>
            <button onclick="injectAndSave()" class="w-full py-3 bg-amber-600 text-white text-[10px] font-black uppercase hover:bg-amber-500 transition-all shadow-lg border border-amber-500/50">Inject & Save to Cloud</button>
            <div id="status-msg"></div>
        </div>
        <button onclick="toggleSyncConsole()" class="mt-4 text-[9px] text-zinc-600 uppercase font-bold hover:text-zinc-400">Close</button>
    </div>

    <div id="label-float"><div class="cyber-icon-frame"><img id="label-icon" src="" class="w-8 h-8 object-cover" onerror="imgError(this)"></div><span id="label-text"></span></div>

    <div id="detail-card" class="hidden absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[95%] md:w-[850px] detail-modal flex flex-col shadow-2xl rounded-sm" onclick="event.stopPropagation()">
        <div class="p-8 md:p-12 overflow-y-auto max-h-[85vh] text-white text-left">
            <button onclick="closeDetail()" class="float-right text-zinc-500 hover:text-white text-4xl">&times;</button>
            <div class="flex items-start gap-6 mb-8">
                <div class="cyber-icon-frame hidden md:block shrink-0"><img id="card-icon" src="" class="w-20 h-20 object-cover" onerror="imgError(this)"></div>
                <h2 id="card-title" class="text-3xl md:text-5xl font-black border-l-4 border-amber-500 pl-6 uppercase italic leading-tight"></h2>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                <div class="space-y-8">
                    <section><h4 class="text-zinc-500 font-black uppercase text-[10px] mb-2 opacity-50">// Origine</h4><p id="card-who-what" class="text-zinc-100 text-xl font-light"></p></section>
                    <section><h4 class="text-zinc-500 font-black uppercase text-[10px] mb-2 opacity-50">// Temporalit√©</h4><p id="card-when" class="text-amber-500 font-bold text-xl italic"></p></section>
                </div>
                <section class="bg-white/5 p-8 border border-white/5">
                    <h4 class="text-zinc-500 font-black uppercase text-[10px] mb-4 opacity-50">// Description & Impact</h4>
                    <p id="card-how" class="text-zinc-300 italic text-base leading-relaxed"></p>
                    <div id="link-area" class="mt-10 hidden border-t border-white/10 pt-6">
                         <h4 class="text-pink-400 font-black uppercase text-[10px] mb-2">// Oracle R√©alis√©</h4>
                         <button id="jump-btn" class="w-full py-4 bg-pink-500/20 border border-pink-500/50 text-pink-300 text-[10px] font-black uppercase hover:bg-pink-500 hover:text-white transition-all shadow-lg flex items-center justify-center gap-2">
                            <span>Voir la r√©alit√©</span> <span id="jump-year" class="bg-black/50 px-2 py-0.5 rounded"></span>
                         </button>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <script>
        const CLOUD_URL = 'https://script.google.com/macros/s/AKfycbwO_yeYQNu22CGFGomksexZ3m4Fk_uS9hd9uzdYYPPQNSM1tky5c-xzlT4PJrQaQojM/exec'; 
        
        const CATEGORY_COLORS = {
            "üü° SUBSTRAT": "#fbbf24", "üîµ INTELLIGENCE": "#3b82f6", "üî¥ MATRICE": "#ef4444",      
            "üü£ EXTENSION": "#a855f7", "üü¢ VIVANT": "#10b981", "‚ò¢Ô∏è RISQUES": "#f97316",      
            "‚ö™ CONVERGENCE": "#ffffff", "üíó ORACLES": "#f472b6", "DEFAUT": "#9ca3af"
        };
        
        const FALLBACK_IMG = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiNmYmJmMjQiIHN0cm9rZS13aWR0aD0iMSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48cmVjdCB4PSIzIiB5PSIzIiB3aWR0aD0iMTgiIGhlaWdodD0iMTgiIHJ4PSIyIiByeT0iMiI+PC9yZWN0Pjwvc3ZnPg==';
        
        // Backup l√©ger au cas o√π
        const BACKUP_DATA = [{"year":2026,"value":50000,"label":"LE GENOU","category":"‚ö™ CONVERGENCE","whoWhat":"Exocortex"}];

        Chart.register(ChartDataLabels);
        let loomChart, currentData = { strands: [] };

        const hexToRgba = (hex, a) => `rgba(${parseInt(hex.slice(1,3),16)},${parseInt(hex.slice(3,5),16)},${parseInt(hex.slice(5,7),16)},${a})`;
        const decimalToDate = (v) => {
            const y = Math.floor(v), f = v - y;
            if (f < 0.05) return y.toString();
            return `T${Math.floor(f * 4) + 1} ${y}`;
        };
        function imgError(image) { image.onerror = null; image.src = FALLBACK_IMG; image.style.opacity = "0.5"; }
        function toggleSyncConsole() { 
            const el = document.getElementById('sync-console'); 
            el.style.display = (el.style.display === 'flex') ? 'none' : 'flex';
            document.getElementById('status-msg').style.display = 'none';
        }
        function closeAll() { closeDetail(); document.getElementById('sync-console').style.display = 'none'; }
        
        function showStatus(msg, type) {
            const el = document.getElementById('status-msg');
            el.style.display = 'block';
            el.innerText = msg;
            el.className = type === 'error' ? 'status-error' : (type === 'success' ? 'status-success' : 'status-info');
        }

        // --- RESET VIEWPORT ---
        function resetToModern() {
            if (!loomChart) return;
            loomChart.options.scales.x.min = 1960; 
            loomChart.options.scales.x.max = 2040;
            loomChart.update('active');
        }

        // --- DATA LOGIC ---
        function validateInput(json) {
            if (!Array.isArray(json)) throw new Error("Format invalide.");
            return true;
        }

        function convertFlatDataToStrands(flatData) {
            const strandsMap = {};
            flatData.sort((a, b) => a.year - b.year); // Vital pour les lignes

            flatData.forEach(row => {
                if (!row.year || !row.label) return;
                let catName = (row.category || "DEFAUT").trim();
                
                if (!CATEGORY_COLORS[catName]) {
                    const match = Object.keys(CATEGORY_COLORS).find(k => k.includes(catName));
                    if (match) catName = match;
                    else catName = "DEFAUT";
                }

                if (!strandsMap[catName]) {
                    strandsMap[catName] = {
                        name: catName,
                        color: CATEGORY_COLORS[catName],
                        events: []
                    };
                }
                strandsMap[catName].events.push({
                    year: parseFloat(row.year),
                    value: parseFloat(row.value) || 10,
                    label: row.label,
                    whoWhat: row.whoWhat || "",
                    how: row.description || row.how || "",
                    img: row.image || row.img || "",
                    realYear: row.realYear ? parseFloat(row.realYear) : null
                });
            });
            return { strands: Object.values(strandsMap) };
        }

        function updateChart(rawData) {
            let processed = rawData.strands ? rawData : convertFlatDataToStrands(rawData);
            currentData = processed;
            loomChart.data.datasets = processed.strands.map(s => ({
                label: `${s.name} (${s.events.length})`,
                data: s.events.map(e => ({ 
                    x: e.year, y: e.value, label: e.label, whoWhat: e.whoWhat, how: e.how, img: e.img, realYear: e.realYear 
                })),
                borderColor: s.color, backgroundColor: s.color, 
                tension: 0.3, pointRadius: 4, hitRadius: 15
            }));
            loomChart.update('none'); // Pas d'anim pour √©viter le saut d'√©chelle
        }

        async function loadData() {
            try {
                const res = await fetch(CLOUD_URL);
                const txt = await res.text();
                if (txt.trim().startsWith("<") || txt.length < 5) throw new Error("Err");
                const json = JSON.parse(txt);
                validateInput(json);
                updateChart(json);
                console.log("Cloud charg√©.");
            } catch (e) { 
                console.warn("Backup charg√©.");
                updateChart(BACKUP_DATA);
            } finally {
                // ON NE RESET PAS ICI CAR LES OPTIONS SONT D√âJ√Ä HARDCOD√âES DANS CHARTCONFIG
                // Cela emp√™che le saut vers le pass√©
                document.getElementById('loading-overlay').style.opacity = '0';
                setTimeout(() => document.getElementById('loading-overlay').remove(), 500);
            }
        }

        async function injectAndSave() {
            const textArea = document.getElementById('json-paste');
            const content = textArea.value.trim();
            if (!content) return;
            try {
                const parsed = JSON.parse(content);
                validateInput(parsed);
                updateChart(parsed);
                showStatus("Sauvegarde...", "info");
                await fetch(CLOUD_URL, { method: 'POST', body: JSON.stringify(parsed), headers: { "Content-Type": "text/plain;charset=utf-8" }});
                showStatus("SUCC√àS !", "success");
                textArea.value = ""; 
                setTimeout(() => toggleSyncConsole(), 1500);
            } catch(err) { showStatus("Erreur", "error"); }
        }

        // --- INTERACTION ---
        function showDetail(d) {
            document.getElementById('card-title').innerText = d.label;
            document.getElementById('card-who-what').innerText = d.whoWhat || "N/A";
            document.getElementById('card-when').innerText = decimalToDate(d.x);
            document.getElementById('card-how').innerText = d.how || "";
            document.getElementById('card-icon').src = d.img || FALLBACK_IMG;
            
            const area = document.getElementById('link-area');
            const btn = document.getElementById('jump-btn');
            const yearSpan = document.getElementById('jump-year');
            
            if (d.realYear) {
                area.classList.remove('hidden');
                yearSpan.innerText = decimalToDate(d.realYear);
                btn.onclick = () => jumpToTarget(d.realYear);
            } else {
                area.classList.add('hidden');
            }
            document.getElementById('detail-card').classList.remove('hidden');
        }

        function jumpToTarget(targetYear) {
            document.getElementById('detail-card').classList.add('hidden');
            const scale = loomChart.scales.x;
            const range = scale.max - scale.min;
            loomChart.options.scales.x.min = targetYear - (range / 2);
            loomChart.options.scales.x.max = targetYear + (range / 2);
            loomChart.update('active');
            
            let target = null, minDist = Infinity;
            loomChart.data.datasets.forEach(ds => {
                ds.data.forEach(p => {
                    const dist = Math.abs(p.x - targetYear);
                    if (dist < minDist && dist < 1.0) { minDist = dist; target = p; }
                });
            });
            if (target) setTimeout(() => showDetail(target), 600);
        }

        function closeDetail() { document.getElementById('detail-card').classList.add('hidden'); }

        // --- CHART CONFIG (LE C≈íUR DU FIX) ---
        const chartConfig = {
            type: 'line', data: { datasets: [] },
            options: {
                responsive: true, maintainAspectRatio: false,
                layout: { padding: { top: 60, bottom: 20, left: 10, right: 80 } }, 
                scales: {
                    x: { 
                        type: 'linear', 
                        // --- LE FIX EST ICI : MIN/MAX FIX√âS EN DUR √Ä L'INITIALISATION ---
                        min: 1960, 
                        max: 2040, 
                        // ----------------------------------------------------------------
                        ticks: { color: '#666', font: { family: 'JetBrains Mono' }, callback: (v) => decimalToDate(v) }, 
                        grid: { color: '#1a1a1a' } 
                    },
                    y: { type: 'logarithmic', position: 'right', ticks: { color: '#222' }, grid: { color: '#080808' } }
                },
                plugins: {
                    legend: { display: true, position: 'left', align: 'start', labels: { color: '#888', font: { size: 10 }, boxWidth: 10 } },
                    tooltip: { enabled: false },
                    zoom: { 
                        // Limites tr√®s larges pour permettre le scroll vers le pass√© lointain si voulu
                        limits: { x: { min: -500, max: 2100, minRange: 0.25 } }, 
                        zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' }, 
                        pan: { enabled: true, mode: 'xy' }
                    },
                    datalabels: {
                        display: true, color: '#fff', align: (ctx) => ctx.dataIndex % 2 === 0 ? 'top' : 'bottom',
                        offset: 35, backgroundColor: (ctx) => hexToRgba(ctx.dataset.borderColor, 0.8),
                        borderRadius: 3, padding: 6, font: { size: 10, weight: 'bold', family: 'Inter' },
                        formatter: (v) => v.label ? v.label : '',
                        listeners: { 
                            click: (ctx) => showDetail(ctx.dataset.data[ctx.dataIndex]),
                            enter: (ctx) => { ctx.chart.canvas.style.cursor = 'pointer'; return true; },
                            leave: (ctx) => { ctx.chart.canvas.style.cursor = 'default'; return true; }
                        }
                    }
                },
                onHover: (e, el) => {
                    const f = document.getElementById('label-float'), img = document.getElementById('label-icon');
                    if (el.length > 0) {
                        const d = loomChart.data.datasets[el[0].datasetIndex].data[el[0].index];
                        f.style.display = 'flex'; f.style.left = (e.x + 15) + 'px'; f.style.top = (e.y - 15) + 'px';
                        document.getElementById('label-text').innerText = d.label;
                        img.src = d.img || FALLBACK_IMG;
                    } else f.style.display = 'none';
                }
            },
            plugins: [{
                id: 'calloutLines',
                afterDraw: (chart) => {
                    const ctx = chart.ctx; ctx.save();
                    chart.data.datasets.forEach((ds, dsIdx) => {
                        const meta = chart.getDatasetMeta(dsIdx);
                        if (meta.hidden) return;
                        meta.data.forEach((element, i) => {
                            const { x, y } = element.tooltipPosition();
                            if (!x || !y) return;
                            const labelY = (i % 2 === 0) ? y - 35 : y + 35; 
                            ctx.beginPath(); ctx.setLineDash([2, 3]); ctx.lineWidth = 1; 
                            ctx.strokeStyle = ds.borderColor.replace('rgb', 'rgba').replace(')', ', 0.5)');
                            ctx.moveTo(x, y); ctx.lineTo(x, labelY); ctx.stroke();
                        });
                    });
                    ctx.restore();
                }
            }]
        };

        window.onload = () => {
            const canvas = document.getElementById('loomChart');
            loomChart = new Chart(canvas, chartConfig);
            loadData();
            new ResizeObserver(() => loomChart.resize()).observe(document.body);
        };
    </script>
</body>
</html>