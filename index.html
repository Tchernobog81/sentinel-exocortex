<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>THE LOOM : EXOCORTEX v104 (Precision)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&family=Inter:wght@300;400;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root { --bg: #010102; --sidebar-bg: #050508; --border: rgba(255,255,255,0.08); --accent: #fbbf24; }
        
        /* CORRECTIF : Texte s√©lectionnable (user-select: text) */
        html, body { 
            margin: 0; padding: 0; width: 100vw; height: 100dvh; 
            background-color: var(--bg); overflow: hidden; position: fixed; inset: 0; 
            font-family: 'JetBrains Mono', monospace; color: white; 
            user-select: text; /* PERMET LA COPIE */
        }

        /* LAYOUT GLOBAL */
        #viewport { position: absolute; inset: 0; display: flex; }

        /* SIDEBAR GAUCHE */
        aside {
            width: 260px; height: 100%; 
            background: var(--sidebar-bg); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; z-index: 20;
            user-select: none; /* On garde la sidebar non-s√©lectionnable pour l'UI, sauf les listes */
        }

        /* HEADER DANS SIDEBAR */
        .brand-header {
            padding: 15px; border-bottom: 1px solid var(--border);
            display: flex; flex-direction: column; gap: 10px;
        }
        .brand-title { font-size: 11px; font-weight: 900; letter-spacing: 0.1em; color: #666; text-transform: uppercase; }
        .brand-version { color: var(--accent); }
        
        /* TIMER GAUCHE (CORRIG√â) */
        .timer-badge { font-size: 10px; color: #10b981; font-weight: bold; background: rgba(16, 185, 129, 0.1); padding: 2px 6px; border-radius: 4px; align-self: flex-start; }

        /* FLUX ENTRANT */
        #flux-container {
            flex: 0 0 35%; 
            border-bottom: 1px solid var(--border);
            padding: 15px; overflow: hidden; display: flex; flex-direction: column;
        }
        .section-title { font-size: 10px; color: var(--accent); font-weight: 800; text-transform: uppercase; margin-bottom: 8px; display: flex; justify-content: space-between; }
        #activity-list { overflow-y: auto; list-style: none; padding: 0; margin: 0; flex: 1; user-select: text; /* Contenu copiable */ }
        #activity-list li { font-size: 10px; color: #bbb; margin-bottom: 6px; padding-bottom: 4px; border-bottom: 1px solid rgba(255,255,255,0.03); line-height: 1.4; }
        
        /* L√âGENDE */
        #legend-container {
            flex: 1; padding: 15px; overflow-y: auto; user-select: none;
        }
        .legend-item { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; cursor: pointer; transition: opacity 0.2s; }
        .legend-item:hover { opacity: 0.8; }
        .legend-item.hidden-line { opacity: 0.3; }
        .legend-color { width: 10px; height: 10px; border-radius: 2px; flex-shrink: 0; }
        .legend-text { font-size: 10px; color: #888; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* ZONE GRAPHIQUE */
        main { flex: 1; position: relative; height: 100%; background: var(--bg); display: flex; flex-direction: column; }
        
        /* TOP BAR */
        .top-bar {
            height: 40px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: flex-end; align-items: center; padding: 0 20px; gap: 15px; user-select: none;
        }
        .hud-btn { font-size: 10px; font-weight: 800; color: #666; text-transform: uppercase; cursor: pointer; transition: color 0.2s; }
        .hud-btn:hover { color: white; }
        .hud-btn.inject { color: var(--accent); border: 1px solid rgba(251, 191, 36, 0.3); padding: 2px 8px; border-radius: 2px; }

        /* CANVAS */
        .canvas-wrapper { flex: 1; position: relative; width: 100%; overflow: hidden; }
        
        /* ECRAN DIAGNOSTIC */
        #loading-screen { 
            position: fixed; inset: 0; background: #020205; z-index: 9000; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            font-family: 'JetBrains Mono'; transition: opacity 0.5s; user-select: none;
        }
        #debug-log {
            width: 80%; max-width: 600px; height: 200px; 
            background: #000; border: 1px solid #333; 
            color: #00ff00; font-size: 10px; padding: 10px; 
            overflow-y: auto; margin-top: 20px; white-space: pre-wrap;
        }
        #btn-emergency {
            margin-top: 20px; padding: 10px 20px; background: #333; color: white; border: 1px solid #666;
            font-size: 10px; text-transform: uppercase; cursor: pointer; display: none;
        }

        /* MODALS */
        #sync-console { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            width: 450px; background: #08080c; border: 1px solid var(--accent); 
            display: none; flex-direction: column; padding: 20px; z-index: 6000; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.9);
        }
        #upload-ticker {
            height: 20px; margin-top: 15px; font-size: 11px; color: var(--accent); 
            font-weight: bold; overflow: hidden; white-space: nowrap; text-align: center;
        }
        #detail-card { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90%; max-width: 600px; background: rgba(5,5,8,0.98); 
            border: 1px solid #333; padding: 2rem; z-index: 5000; display: none;
            box-shadow: 0 0 50px rgba(0,0,0,0.8); user-select: text; /* Copiable */
        }
        #label-float { position: fixed; pointer-events: none; background: rgba(0,0,0,0.95); border: 1px solid var(--accent); color: #fff; padding: 5px 10px; z-index: 4000; display: none; align-items: center; gap: 8px; font-size: 10px; }
        .cyber-icon-frame { width: 24px; height: 24px; border: 1px solid #333; overflow: hidden; background: #000; }
    </style>
</head>
<body>

    <div id="loading-screen">
        <div class="text-xl font-black text-white mb-2 tracking-widest">SYSTEM BOOT</div>
        <div class="text-xs text-zinc-500 mb-4">Protocole V104 : Initialisation...</div>
        <div id="debug-log">Init...</div>
        <button id="btn-emergency" onclick="loadBackupData()">‚ö†Ô∏è MODE SURVIE (OFFLINE)</button>
    </div>

    <div id="viewport">
        <aside>
            <div class="brand-header">
                <div class="brand-title">The Loom <span class="brand-version">v104</span></div>
                <div id="timer-badge" class="timer-badge">NEXT --:--</div>
            </div>

            <div id="flux-container">
                <div class="section-title">
                    <span>Flux Entrant (12h)</span>
                    <span id="flux-count" class="text-zinc-500">0</span>
                </div>
                <ul id="activity-list" class="scrollbar-thin">
                    <li class="italic text-zinc-700">En attente...</li>
                </ul>
            </div>

            <div id="legend-container"></div>
        </aside>

        <main>
            <div class="top-bar">
                <span id="sync-status" class="text-[9px] font-bold text-zinc-600 mr-auto">OFFLINE</span>
                <button onclick="resetView()" class="hud-btn">Vue Standard (1985)</button>
                <button onclick="toggleConsole()" class="hud-btn inject">INJECT DATA</button>
            </div>
            <div class="canvas-wrapper">
                <canvas id="loomChart"></canvas>
            </div>
        </main>
    </div>

    <div id="sync-console">
        <h3 class="text-amber-500 font-bold text-xs mb-2 uppercase">Injection Donn√©es</h3>
        <textarea id="json-paste" class="w-full h-32 bg-black border border-zinc-800 text-green-500 text-[10px] p-2 mb-4 font-mono outline-none" placeholder='[{"year": 2026, "label": "Exemple", "category": "..."}]'></textarea>
        <button onclick="executeInjection()" id="btn-inject" class="w-full bg-amber-600 text-black font-bold py-3 text-[10px] uppercase hover:bg-amber-500 transition-colors">LANCER L'UPLOAD</button>
        <div id="upload-ticker"></div>
        <button onclick="toggleConsole()" class="mt-4 text-[9px] text-zinc-600 uppercase hover:text-white text-center w-full">Fermer</button>
    </div>

    <div id="label-float"><div class="cyber-icon-frame"><img id="label-icon" src=""></div><span id="label-text"></span></div>

    <div id="detail-card">
        <button onclick="closeDetail()" class="absolute top-4 right-4 text-zinc-500 hover:text-white text-2xl">&times;</button>
        <h2 id="card-title" class="text-2xl font-black text-white mb-2 text-amber-500 uppercase"></h2>
        <div class="flex gap-4 text-[10px] text-zinc-500 uppercase mb-4 border-b border-zinc-800 pb-2">
            <span>Source: <b id="card-who" class="text-zinc-300"></b></span>
            <span>Date: <b id="card-date" class="text-zinc-300"></b></span>
        </div>
        <p id="card-desc" class="text-zinc-300 italic text-sm leading-relaxed"></p>
        <div class="mt-4 text-[9px] text-zinc-700 font-mono">ID: <span id="card-stamp"></span></div>
    </div>

    <script>
        const CLOUD_URL = 'https://script.google.com/macros/s/AKfycbwg-ZzMeSRyoaTRV-u824eQvnd8tHYxTsk-xDSK4vhYy42OnMpFrpumj2NSEaA45gP-/exec'; 
        
        const BACKUP_DATA = [
            { "year": 1945, "value": 400, "label": "Trinity (BACKUP)", "category": "‚ò¢Ô∏è RISQUES" },
            { "year": 1969, "value": 5000, "label": "Apollo 11", "category": "üü£ EXTENSION" },
            { "year": 1989, "value": 15000, "label": "WWW", "category": "üî¥ MATRICE" },
            { "year": 2026, "value": 200000, "label": "LE GENOU", "category": "‚ö™ CONVERGENCE" }
        ];

        const COLORS = { "üü° SUBSTRAT": "#fbbf24", "üîµ INTELLIGENCE": "#3b82f6", "üî¥ MATRICE": "#ef4444", "üü£ EXTENSION": "#a855f7", "üü¢ VIVANT": "#10b981", "‚ò¢Ô∏è RISQUES": "#f97316", "‚ö™ CONVERGENCE": "#ffffff", "üíó ORACLES": "#f472b6", "DEFAUT": "#9ca3af" };
        const FALLBACK_IMG = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiNmYmJmMjQiIHN0cm9rZS13aWR0aD0iMSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48cmVjdCB4PSIzIiB5PSIzIiB3aWR0aD0iMTgiIGhlaWdodD0iMTgiIHJ4PSIyIiByeT0iMiI+PC9yZWN0Pjwvc3ZnPg==';

        Chart.register(ChartDataLabels);
        let loomChart;

        function log(msg, type="info") {
            const el = document.getElementById('debug-log');
            const time = new Date().toLocaleTimeString();
            let color = "#00ff00"; if(type==="error") color="#ef4444"; if(type==="warn") color="#f59e0b";
            el.innerHTML += `<div style="color:${color}">[${time}] ${msg}</div>`;
            el.scrollTop = el.scrollHeight;
        }

        const decToDate = v => { if(v < 0) return Math.floor(v); const y=Math.floor(v); return `T${Math.floor((v-y)*4)+1} ${y}`; };
        const hexToRgba = (hex, a) => `rgba(${parseInt(hex.slice(1,3),16)},${parseInt(hex.slice(3,5),16)},${parseInt(hex.slice(5,7),16)},${a})`;

        async function loadData(init = false) {
            try {
                if(init) log("D√©marrage du protocole de synchronisation...");
                const res = await fetch(CLOUD_URL);
                
                if (!res.ok) throw new Error(`HTTP Error ${res.status}`);
                const text = await res.text();
                
                if(text.trim().startsWith("<!DOCTYPE") || text.includes("<html")) {
                    throw new Error("Erreur Serveur: R√©ponse HTML invalide.");
                }

                let json;
                try { json = JSON.parse(text); } catch(e) { throw new Error("JSON corrompu."); }
                log(`Donn√©es re√ßues: ${json.length} items.`);

                updateChart(json);
                updateFlux(json);
                updateLegend(json);

                if (init) {
                    handleSmartFocus(json); // APPLIQUER LA R√àGLE INTANGIBLE
                    setTimeout(() => {
                        const ls = document.getElementById('loading-screen');
                        ls.style.opacity = 0;
                        setTimeout(() => ls.remove(), 500);
                    }, 500);
                }

                // Update Sync Status (Haut Droit)
                const d = new Date();
                const st = document.getElementById('sync-status');
                st.innerText = `LAST SYNC ${("0"+d.getHours()).slice(-2)}:${("0"+d.getMinutes()).slice(-2)}`;
                st.className = 'text-[9px] font-bold text-emerald-500 mr-auto';

            } catch(e) {
                console.error(e);
                log(`ERREUR FATALE: ${e.message}`, "error");
                const st = document.getElementById('sync-status');
                st.innerText = "CONNEXION ERROR";
                st.className = 'text-[9px] font-bold text-red-500 mr-auto';
                document.getElementById('btn-emergency').style.display = 'block';
            }
        }

        function loadBackupData() {
            log("Mode Survie Activ√©", "warn");
            updateChart(BACKUP_DATA);
            updateFlux(BACKUP_DATA);
            updateLegend(BACKUP_DATA);
            handleSmartFocus(BACKUP_DATA);
            setTimeout(() => document.getElementById('loading-screen').remove(), 500);
        }

        // --- R√àGLES INTANGIBLES (CORRIG√âES) ---
        function handleSmartFocus(json) {
            const now = new Date();
            const twelveHoursAgo = new Date(now.getTime() - (12 * 60 * 60 * 1000));
            
            // Cherche les events AVEC timestamp de moins de 12h
            const recent = json.filter(d => d.timestamp && new Date(d.timestamp) > twelveHoursAgo);
            
            if (recent.length > 0) {
                // R√àGLE 1 : Si flux r√©cent, on centre dessus (+/- 5 ans)
                recent.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
                const target = recent[0].year;
                loomChart.options.scales.x.min = target - 5;
                loomChart.options.scales.x.max = target + 5;
                log(`Smart Focus: Activit√© r√©cente en ${target}`);
            } else {
                // R√àGLE 2 : Sinon, centrage standard 1985 (1945-2025)
                resetView();
                log(`Smart Focus: Standby. Centrage 1985.`);
            }
            loomChart.update();
        }

        function resetView() {
            loomChart.options.scales.x.min = 1945;
            loomChart.options.scales.x.max = 2025;
            loomChart.update();
        }

        function updateChart(flatData) {
            const strands = {};
            if(!Array.isArray(flatData)) return;
            flatData.sort((a,b) => a.year - b.year);
            flatData.forEach(d => {
                let c = d.category || "DEFAUT";
                if(!COLORS[c]) c = Object.keys(COLORS).find(k => k.includes(c)) || "DEFAUT";
                if(!strands[c]) strands[c] = { label: c, borderColor: COLORS[c], backgroundColor: COLORS[c], data: [], pointRadius: 4, hitRadius: 10, tension: 0.3 };
                strands[c].data.push({ x: d.year, y: d.value, ...d });
            });
            loomChart.data.datasets = Object.values(strands);
            loomChart.update('none');
        }

        function updateFlux(data) {
            const now = new Date();
            const limit = new Date(now.getTime() - (12 * 60 * 60 * 1000)); 
            const recent = data.filter(d => d.timestamp && new Date(d.timestamp) > limit)
                               .sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            document.getElementById('flux-count').innerText = recent.length;
            const list = document.getElementById('activity-list');
            list.innerHTML = '';
            
            if(recent.length === 0) list.innerHTML = '<li class="italic text-zinc-700">Aucun flux r√©cent...</li>';
            else recent.forEach(item => {
                const li = document.createElement('li');
                const col = COLORS[item.category] || '#fff';
                const mins = Math.floor((now - new Date(item.timestamp))/60000);
                const timeStr = mins < 60 ? `${mins}m` : `${Math.floor(mins/60)}h`;
                li.innerHTML = `<span style="color:${col}">‚óè</span> <span class="text-zinc-500 mr-1">[${timeStr}]</span> ${item.label}`;
                list.appendChild(li);
            });
        }

        function updateLegend(data) {
            const counts = {};
            data.forEach(d => {
                let c = d.category || "DEFAUT";
                if(!COLORS[c]) c = Object.keys(COLORS).find(k => k.includes(c)) || "DEFAUT";
                counts[c] = (counts[c] || 0) + 1;
            });
            const container = document.getElementById('legend-container');
            container.innerHTML = ''; 
            Object.keys(COLORS).forEach(cat => {
                if(!counts[cat]) return;
                const div = document.createElement('div');
                div.className = 'legend-item';
                div.onclick = () => {
                    const ds = loomChart.data.datasets.find(d => d.label === cat);
                    if(ds) {
                        const meta = loomChart.getDatasetMeta(loomChart.data.datasets.indexOf(ds));
                        meta.hidden = meta.hidden === null ? !ds.hidden : null;
                        div.classList.toggle('hidden-line');
                        loomChart.update();
                    }
                };
                div.innerHTML = `<div class="legend-color" style="background:${COLORS[cat]}"></div><div class="legend-text" style="flex:1">${cat.split(' ')[1] || cat}</div><div class="legend-text" style="color:#444">${counts[cat]}</div>`;
                container.appendChild(div);
            });
        }

        async function executeInjection() {
            const txt = document.getElementById('json-paste').value;
            const btn = document.getElementById('btn-inject');
            const ticker = document.getElementById('upload-ticker');
            
            if(!txt) return;

            try {
                const json = JSON.parse(txt);
                const now = new Date().toISOString();
                json.forEach(i => { if(!i.timestamp) i.timestamp = now; });
                
                btn.disabled = true;
                btn.innerText = "UPLOADING...";
                btn.classList.add('opacity-50');
                
                let idx = 0;
                const tInt = setInterval(() => {
                    if(idx >= json.length) idx = 0;
                    ticker.innerText = `> SENDING: ${json[idx].label}...`;
                    idx++;
                }, 100);

                await fetch(CLOUD_URL, { method:'POST', body:JSON.stringify(json) });

                clearInterval(tInt);
                ticker.innerText = "> SUCCESS: DATA INJECTED.";
                ticker.style.color = "#10b981";
                
                setTimeout(() => {
                    toggleConsole();
                    loadData(true); 
                    btn.disabled = false;
                    btn.innerText = "LANCER L'UPLOAD";
                    btn.classList.remove('opacity-50');
                    document.getElementById('json-paste').value = "";
                    ticker.innerText = "";
                    ticker.style.color = "var(--accent)";
                }, 1500);

            } catch(e) {
                alert("Erreur: " + e.message);
                btn.disabled = false;
                btn.innerText = "RETRY";
                btn.classList.remove('opacity-50');
            }
        }

        // --- TIMER COMPTE √Ä REBOURS GAUCHE (hh:mm) ---
        function updateTimer() {
            const now = new Date();
            // Cibles : 8h et 20h UTC
            const targets = [8, 20].map(h => {
                const d = new Date(now); 
                d.setUTCHours(h,0,0,0);
                if(d <= now) d.setDate(d.getDate()+1);
                return d;
            }).sort((a,b)=>a-b);
            
            const diff = targets[0] - now;
            const h = Math.floor(diff/3600000);
            const m = Math.floor((diff%3600000)/60000);
            
            const hStr = ("0"+h).slice(-2);
            const mStr = ("0"+m).slice(-2);
            document.getElementById('timer-badge').innerText = `NEXT ${hStr}:${mStr}`;
        }

        function toggleConsole() { const c=document.getElementById('sync-console'); c.style.display=c.style.display==='flex'?'none':'flex'; }
        function showDetail(d) {
            document.getElementById('card-title').innerText = d.label;
            document.getElementById('card-who').innerText = d.whoWhat || "?";
            document.getElementById('card-date').innerText = decToDate(d.x);
            document.getElementById('card-desc').innerText = d.description || d.how || "";
            document.getElementById('card-stamp').innerText = d.timestamp || "ARCHIVE";
            document.getElementById('detail-card').style.display = 'block';
        }
        function closeDetail() { document.getElementById('detail-card').style.display = 'none'; }

        window.onload = () => {
            const ctx = document.getElementById('loomChart');
            loomChart = new Chart(ctx, {
                type: 'line',
                data: { datasets: [] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    layout: { padding: { left: 20, right: 50, top: 20, bottom: 20 } },
                    scales: {
                        x: { type: 'linear', min: 1945, max: 2025, grid: { color: '#222' }, ticks: { color: '#666', callback: decToDate } },
                        y: { type: 'logarithmic', position: 'right', grid: { color: '#111' } }
                    },
                    plugins: {
                        legend: { display: false }, 
                        datalabels: { 
                            color: '#fff', align: 'top', offset: 12, 
                            backgroundColor: ctx => hexToRgba(ctx.dataset.borderColor, 0.8),
                            borderRadius: 2, padding: 4, font: { size: 9, weight: 'bold' },
                            formatter: v => v.label, clip: false,
                            listeners: { click: c => showDetail(c.dataset.data[c.dataIndex]) }
                        },
                        zoom: { zoom: { wheel: { enabled: true }, mode: 'x' }, pan: { enabled: true, mode: 'xy' } }
                    },
                    onHover: (e, el) => {
                        const f = document.getElementById('label-float'), img = document.getElementById('label-icon');
                        if (el.length > 0) {
                            const d = loomChart.data.datasets[el[0].datasetIndex].data[el[0].index];
                            f.style.display = 'flex'; f.style.left = (e.x + 15) + 'px'; f.style.top = (e.y - 15) + 'px';
                            document.getElementById('label-text').innerText = d.label; img.src = d.img || FALLBACK_IMG;
                        } else f.style.display = 'none';
                    }
                }
            });
            
            loadData(true);
            setInterval(() => loadData(false), 300000);
            setInterval(updateTimer, 60000); updateTimer();
        };
    </script>
</body>
</html>
