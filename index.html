<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>THE LOOM : EXOCORTEX v98 (Countdown)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&family=Inter:wght@300;400;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root { --bg: #010102; --sidebar-bg: #050508; --border: rgba(255,255,255,0.08); --accent: #fbbf24; }
        html, body { 
            margin: 0; padding: 0; width: 100vw; height: 100dvh; 
            background-color: var(--bg); overflow: hidden; position: fixed; inset: 0; 
            font-family: 'JetBrains Mono', monospace; color: white; user-select: none;
        }
        
        #viewport { position: absolute; inset: 0; display: flex; flex-direction: column; }
        
        /* HEADER */
        header { 
            height: 40px; background: var(--sidebar-bg); border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center; padding: 0 1rem; z-index: 20;
        }
        
        /* LAYOUT */
        .main-area { flex: 1; display: flex; overflow: hidden; }
        
        /* SIDEBAR (La Colonne Unifi√©e) */
        aside {
            width: 250px; background: var(--sidebar-bg); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; z-index: 10;
        }
        
        /* BLOC 1 : FLUX ENTRANT */
        #activity-section {
            padding: 15px; border-bottom: 1px solid var(--border);
            flex-shrink: 0; max-height: 45%; display: flex; flex-direction: column;
        }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        #activity-title { font-size: 10px; font-weight: 800; color: var(--accent); letter-spacing: 0.1em; text-transform: uppercase; }
        #timer-badge { font-size: 9px; background: rgba(251, 191, 36, 0.1); color: var(--accent); padding: 2px 4px; border-radius: 2px; border: 1px solid rgba(251, 191, 36, 0.3); font-family: 'JetBrains Mono'; }
        
        #activity-meta { font-size: 9px; color: #666; margin-bottom: 10px; font-weight: bold; }
        #activity-list { overflow-y: auto; list-style: none; padding: 0; margin: 0; }
        #activity-list li { font-size: 9px; margin-bottom: 6px; color: #ccc; border-bottom: 1px solid rgba(255,255,255,0.03); padding-bottom: 4px; }
        
        /* BLOC 2 : L√âGENDE (Int√©gr√©e) */
        #legend-section {
            padding: 15px; overflow-y: auto; flex: 1;
        }
        .legend-item { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; cursor: pointer; opacity: 0.7; transition: opacity 0.2s; }
        .legend-item:hover, .legend-item.active { opacity: 1; }
        .legend-dot { width: 8px; height: 8px; border-radius: 2px; }
        .legend-label { font-size: 9px; color: #aaa; font-weight: 700; }
        .legend-count { font-size: 8px; color: #555; margin-left: auto; }

        /* CHART AREA */
        .canvas-wrapper { flex: 1; position: relative; background: var(--bg); }
        
        /* UI OVERLAYS */
        #sync-console { position: fixed; top: 50px; left: 260px; width: 300px; background: #080810; border: 1px solid var(--accent); display: none; flex-direction: column; padding: 1rem; z-index: 6000; box-shadow: 0 10px 30px rgba(0,0,0,0.8); }
        #detail-card { z-index: 5000; background: rgba(5,5,8,0.98); backdrop-filter: blur(20px); border: 1px solid #333; }
        #label-float { position: fixed; pointer-events: none; background: rgba(0,0,0,0.95); border: 1px solid var(--accent); color: #fff; padding: 5px 10px; z-index: 4000; display: none; align-items: center; gap: 8px; font-size: 10px; }
        .cyber-icon-frame { width: 24px; height: 24px; border: 1px solid #333; overflow: hidden; background: #000; }
        
        .hud-btn { @apply text-zinc-500 text-[9px] hover:text-white uppercase font-black transition-all cursor-pointer; }
    </style>
</head>
<body>

    <div id="viewport">
        <header>
            <h1 class="text-[10px] font-black tracking-[0.2em] uppercase text-zinc-500 italic">The Loom <span class="text-amber-500">v98</span></h1>
            <div class="flex items-center gap-3">
                <span id="last-sync-status" class="text-[9px] font-bold text-zinc-700">CONNECTING...</span>
                <button onclick="resetToModern()" class="hud-btn">Reset</button>
                <button onclick="toggleConsole()" class="hud-btn text-amber-500 border border-amber-500/30 px-2 py-0.5 rounded hover:bg-amber-500/10">INJECT</button>
            </div>
        </header>

        <div class="main-area">
            <aside>
                <div id="activity-section">
                    <div class="section-header">
                        <div id="activity-title">Flux Entrant</div>
                        <div id="timer-badge">--:--:--</div>
                    </div>
                    <div id="activity-meta">Recherche du signal...</div>
                    <ul id="activity-list" class="scrollbar-thin"></ul>
                </div>

                <div id="legend-section"></div>
            </aside>

            <main class="canvas-wrapper">
                <canvas id="loomChart"></canvas>
            </main>
        </div>
    </div>

    <div id="sync-console">
        <textarea id="json-paste" class="w-full h-32 bg-black border border-zinc-800 text-green-500 text-[9px] p-2 mb-2 font-mono outline-none" placeholder="Paste JSON..."></textarea>
        <button onclick="injectData()" class="w-full bg-amber-600 text-black font-bold py-2 text-[9px] uppercase hover:bg-amber-500">EXECUTE</button>
    </div>

    <div id="label-float"><div class="cyber-icon-frame"><img id="label-icon" src=""></div><span id="label-text"></span></div>

    <div id="detail-card" class="hidden absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[90%] md:w-[600px] shadow-2xl p-8 text-left" onclick="closeDetail()">
        <button onclick="closeDetail()" class="float-right text-zinc-600 hover:text-white text-xl">&times;</button>
        <h2 id="card-title" class="text-2xl font-black text-white mb-2 text-amber-500"></h2>
        <div class="flex justify-between text-[10px] text-zinc-500 uppercase mb-6 border-b border-zinc-800 pb-2">
            <span id="card-who">SOURCE</span>
            <span id="card-date" class="text-white font-bold">DATE</span>
        </div>
        <div class="text-zinc-300 italic text-sm leading-relaxed" id="card-desc"></div>
        <p class="mt-4 text-[9px] text-zinc-700 font-mono pt-4">ID: <span id="card-stamp"></span></p>
    </div>

    <script>
        // CONFIG
        const CLOUD_URL = 'https://script.google.com/macros/s/AKfycbwO_yeYQNu22CGFGomksexZ3m4Fk_uS9hd9uzdYYPPQNSM1tky5c-xzlT4PJrQaQojM/exec'; 
        const COLORS = { "üü° SUBSTRAT": "#fbbf24", "üîµ INTELLIGENCE": "#3b82f6", "üî¥ MATRICE": "#ef4444", "üü£ EXTENSION": "#a855f7", "üü¢ VIVANT": "#10b981", "‚ò¢Ô∏è RISQUES": "#f97316", "‚ö™ CONVERGENCE": "#ffffff", "üíó ORACLES": "#f472b6", "DEFAUT": "#9ca3af" };
        const FALLBACK_IMG = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiNmYmJmMjQiIHN0cm9rZS13aWR0aD0iMSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48cmVjdCB4PSIzIiB5PSIzIiB3aWR0aD0iMTgiIGhlaWdodD0iMTgiIHJ4PSIyIiByeT0iMiI+PC9yZWN0Pjwvc3ZnPg==';

        Chart.register(ChartDataLabels);
        let loomChart;

        // UTILS
        const decToDate = v => { const y=Math.floor(v); return `T${Math.floor((v-y)*4)+1} ${y}`; };
        const hexToRgba = (hex, a) => `rgba(${parseInt(hex.slice(1,3),16)},${parseInt(hex.slice(3,5),16)},${parseInt(hex.slice(5,7),16)},${a})`;

        async function loadData() {
            try {
                const res = await fetch(CLOUD_URL);
                const json = await res.json();
                updateChart(json);
                updateRecentUI(json);
                updateLegendUI(json);
                
                const d = new Date();
                const st = document.getElementById('last-sync-status');
                st.innerText = `SYNC ${("0"+d.getHours()).slice(-2)}:${("0"+d.getMinutes()).slice(-2)}`;
                st.classList.replace('text-zinc-700', 'text-emerald-500');
            } catch(e) { 
                console.error(e);
                document.getElementById('last-sync-status').innerText = "DISCONNECTED";
                document.getElementById('last-sync-status').classList.replace('text-zinc-700', 'text-red-600');
            }
        }

        function updateChart(flatData) {
            const strands = {};
            // S√©curit√© si donn√©es corrompues
            if(!Array.isArray(flatData)) return;

            flatData.sort((a,b) => a.year - b.year);
            flatData.forEach(d => {
                let c = d.category || "DEFAUT";
                if(!COLORS[c]) c = Object.keys(COLORS).find(k=>k.includes(c)) || "DEFAUT";
                if(!strands[c]) strands[c] = { label: c, borderColor: COLORS[c], backgroundColor: COLORS[c], data: [] };
                strands[c].data.push({ x: d.year, y: d.value, ...d });
            });
            loomChart.data.datasets = Object.values(strands);
            loomChart.update('none');
        }

        // --- COUNTDOWN LOGIC (08:00 & 20:00 UTC) ---
        function updateTimer() {
            const now = new Date();
            const nowUTC = now.getTime(); 
            
            // Cibles aujourd'hui UTC
            const target8 = new Date(now).setUTCHours(8,0,0,0);
            const target20 = new Date(now).setUTCHours(20,0,0,0);
            const targets = [target8, target20];
            
            // Si on a pass√© 20h UTC, la prochaine est 8h demain
            const tomorrow8 = new Date(target8 + 24*3600*1000);
            targets.push(tomorrow8);

            // Trouver la prochaine √©ch√©ance dans le futur
            const next = targets.find(t => t > nowUTC);
            
            if(next) {
                const diff = next - nowUTC;
                const h = Math.floor(diff / (1000 * 60 * 60));
                const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const s = Math.floor((diff % (1000 * 60)) / 1000);
                document.getElementById('timer-badge').innerText = 
                    `${("0"+h).slice(-2)}:${("0"+m).slice(-2)}:${("0"+s).slice(-2)}`;
            }
        }

        // --- GESTION FLUX ENTRANT ---
        function updateRecentUI(data) {
            if(!Array.isArray(data)) return;
            const now = new Date();
            const limit = new Date(now.getTime() - (12 * 60 * 60 * 1000)); // 12h
            
            const recent = data.filter(d => d.timestamp && new Date(d.timestamp) > limit)
                               .sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));

            document.getElementById('activity-meta').innerText = `${recent.length} nouveau(x)`;
            const list = document.getElementById('activity-list');
            list.innerHTML = '';

            if (recent.length === 0) list.innerHTML = '<li class="italic text-zinc-700">R.A.S. (12h)</li>';
            else recent.forEach(item => {
                const li = document.createElement('li');
                const col = COLORS[item.category] || '#fff';
                const mins = Math.floor((now - new Date(item.timestamp))/60000);
                const timeTag = mins < 60 ? `${mins}m` : `${Math.floor(mins/60)}h`;
                li.innerHTML = `<span style="color:${col}">‚óè</span> <span class="text-zinc-500 text-[8px] mr-1">${timeTag}</span> ${item.label}`;
                list.appendChild(li);
            });
        }

        function updateLegendUI(data) {
            const counts = {};
            if(Array.isArray(data)) {
                data.forEach(d => {
                    let c = d.category || "DEFAUT";
                    if(!COLORS[c]) c = Object.keys(COLORS).find(k=>k.includes(c)) || "DEFAUT";
                    counts[c] = (counts[c] || 0) + 1;
                });
            }
            const container = document.getElementById('legend-section');
            container.innerHTML = '';
            Object.keys(COLORS).forEach(cat => {
                if(!counts[cat]) return;
                const div = document.createElement('div');
                div.className = 'legend-item';
                div.onclick = () => toggleDataset(cat, div);
                div.innerHTML = `
                    <div class="legend-dot" style="background:${COLORS[cat]}"></div>
                    <span class="legend-label">${cat.split(' ')[1] || cat}</span>
                    <span class="legend-count">${counts[cat]}</span>
                `;
                container.appendChild(div);
            });
        }

        function toggleDataset(category, element) {
            const ds = loomChart.data.datasets.find(d => d.label === category);
            if(ds) {
                const meta = loomChart.getDatasetMeta(loomChart.data.datasets.indexOf(ds));
                meta.hidden = meta.hidden === null ? !ds.hidden : null;
                element.style.opacity = meta.hidden ? "0.3" : "1";
                loomChart.update();
            }
        }

        async function injectData() {
            const txt = document.getElementById('json-paste').value;
            if(!txt) return;
            try {
                const json = JSON.parse(txt);
                const now = new Date().toISOString();
                // Force timestamp si injection manuelle
                json.forEach(i => { if(!i.timestamp) i.timestamp = now; }); 
                
                // Fermer la console imm√©diatement pour √©viter l'effet "bloqu√©"
                toggleConsole();
                document.getElementById('last-sync-status').innerText = "PUSHING...";
                
                await fetch(CLOUD_URL, { method:'POST', body:JSON.stringify(json) });
                
                // Refresh auto
                loadData();
            } catch(e) { 
                alert("Erreur JSON ou R√©seau"); 
                console.error(e);
            }
        }

        function showDetail(d) {
            document.getElementById('card-title').innerText = d.label;
            document.getElementById('card-who').innerText = d.whoWhat || "N/A";
            document.getElementById('card-date').innerText = decToDate(d.x);
            document.getElementById('card-desc').innerText = d.description || d.how || "";
            document.getElementById('card-stamp').innerText = d.timestamp || "ARCHIVE";
            document.getElementById('detail-card').classList.remove('hidden');
        }
        function closeDetail() { document.getElementById('detail-card').classList.add('hidden'); }
        function toggleConsole() { const c=document.getElementById('sync-console'); c.style.display=c.style.display==='flex'?'none':'flex'; }
        function resetToModern() { loomChart.options.scales.x.min=1960; loomChart.options.scales.x.max=2040; loomChart.update(); }

        window.onload = () => {
            const ctx = document.getElementById('loomChart');
            loomChart = new Chart(ctx, {
                type: 'line',
                data: { datasets: [] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    layout: { padding: { left: 20, right: 50, top: 20, bottom: 20 } },
                    scales: {
                        x: { type: 'linear', min: 1960, max: 2040, grid: { color: '#222' }, ticks: { color: '#666', callback: decToDate } },
                        y: { type: 'logarithmic', position: 'right', grid: { color: '#111' } }
                    },
                    plugins: {
                        legend: { display: false },
                        datalabels: { 
                            color: '#fff', align: 'top', offset: 15, 
                            backgroundColor: ctx => hexToRgba(ctx.dataset.borderColor, 0.8),
                            borderRadius: 2, padding: 4, font: { size: 9, weight: 'bold' },
                            formatter: v => v.label, clip: false,
                            listeners: { click: c => showDetail(c.dataset.data[c.dataIndex]) }
                        },
                        zoom: { zoom: { wheel: { enabled: true }, mode: 'x' }, pan: { enabled: true, mode: 'xy' } }
                    },
                    onHover: (e, el) => {
                        const f = document.getElementById('label-float'), img = document.getElementById('label-icon');
                        if (el.length > 0) {
                            const d = loomChart.data.datasets[el[0].datasetIndex].data[el[0].index];
                            f.style.display = 'flex'; f.style.left = (e.x + 15) + 'px'; f.style.top = (e.y - 15) + 'px';
                            document.getElementById('label-text').innerText = d.label; img.src = d.img || FALLBACK_IMG;
                        } else f.style.display = 'none';
                    }
                }
            });
            
            // Lancement initial
            loadData();
            updateTimer();
            
            // Boucles
            setInterval(loadData, 300000); // Data: 5 min
            setInterval(updateTimer, 1000); // Timer: 1 sec
        };
    </script>
</body>
</html>
