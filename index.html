<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>THE LOOM : EXOCORTEX v96 (System Complete)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&family=Inter:wght@300;400;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root { --bg: #010102; --accent: #fbbf24; --sidebar-width: 220px; }
        html, body { 
            margin: 0; padding: 0; width: 100vw; height: 100dvh; 
            background-color: var(--bg); overflow: hidden; position: fixed; inset: 0; 
            font-family: 'JetBrains Mono', monospace; color: white; user-select: none;
        }
        #viewport { position: absolute; inset: 0; display: flex; flex-direction: column; }
        
        /* HEADER */
        header { 
            height: 50px; background: rgba(0,0,0,0.95); border-bottom: 1px solid rgba(255,255,255,0.05);
            display: flex; justify-content: space-between; align-items: center; padding: 0 1rem; z-index: 2000;
        }
        
        /* LAYOUT PRINCIPAL */
        .main-area { flex: 1; position: relative; display: flex; overflow: hidden; }
        
        /* BARRE LATERALE FIXE */
        #left-sidebar-container {
            width: var(--sidebar-width);
            background: linear-gradient(to right, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0) 100%);
            z-index: 10; padding: 20px 10px; display: flex; flex-direction: column; justify-content: flex-end;
            pointer-events: none; /* Laisse passer les clics sauf sur le bloc actif */
        }
        
        /* BLOC ACTIVITE RECENTE */
        #recent-activity-block {
            pointer-events: auto; background: rgba(20, 20, 25, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1); border-left: 2px solid var(--accent);
            padding: 12px; margin-bottom: 40px; backdrop-filter: blur(10px);
            max-height: 40vh; display: flex; flex-direction: column;
        }
        #recent-title { font-size: 10px; font-weight: 800; color: var(--accent); text-transform: uppercase; margin-bottom: 4px; }
        #recent-meta { font-size: 9px; color: #888; margin-bottom: 8px; font-weight: bold;}
        #recent-list { list-style: none; padding: 0; margin: 0; font-size: 9px; color: #ccc; overflow-y: auto; }
        #recent-list li { margin-bottom: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-bottom: 4px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        
        /* CANVAS */
        .canvas-wrapper { flex: 1; position: relative; }
        
        /* UI HELPERS */
        #sync-console { position: fixed; top: 60px; right: 20px; width: 340px; background: #05050a; border: 1px solid #333; display: none; flex-direction: column; padding: 1.5rem; z-index: 6000; }
        #loading-overlay { position: fixed; inset: 0; background: #000; z-index: 9000; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #666; transition: opacity 0.5s ease; }
        #detail-card { z-index: 5000; background: rgba(5,5,8,0.98); backdrop-filter: blur(20px); border: 1px solid #333; }
        
        /* TOOLTIPS */
        #label-float { position: fixed; pointer-events: none; background: rgba(0,0,0,0.9); border: 1px solid var(--accent); color: #fff; padding: 6px 12px; z-index: 4000; display: none; align-items: center; gap: 10px; font-size: 11px; }
        .cyber-icon-frame { width: 32px; height: 32px; border: 1px solid var(--accent); overflow: hidden; background: #000; }
        
        .hud-btn { @apply text-zinc-500 text-[9px] hover:text-white uppercase font-black transition-all cursor-pointer; }
    </style>
</head>
<body>
    <div id="loading-overlay">SYSTEM LINK : DRIVE...</div>

    <div id="viewport">
        <header>
            <h1 class="text-[10px] font-black tracking-[0.3em] uppercase text-zinc-500 italic">The Loom <span class="text-amber-500 font-bold">v96</span></h1>
            <div class="flex items-center gap-4">
                <span id="last-sync-status" class="text-[9px] font-bold text-zinc-600">OFFLINE</span>
                <button onclick="resetToModern()" class="hud-btn">Reset View</button>
                <button onclick="toggleConsole()" class="hud-btn text-amber-500 border border-amber-500/30 px-2 py-1 rounded hover:bg-amber-500/10">Inject</button>
            </div>
        </header>

        <div class="main-area">
            <aside id="left-sidebar-container">
                <div id="recent-activity-block">
                    <div id="recent-title">Flux Entrant (12h)</div>
                    <div id="recent-meta">Chargement...</div>
                    <ul id="recent-list" class="scrollbar-thin"><li class="text-zinc-600 italic">En attente...</li></ul>
                </div>
            </aside>
            <main class="canvas-wrapper">
                <canvas id="loomChart"></canvas>
            </main>
        </div>
    </div>

    <div id="sync-console">
        <textarea id="json-paste" class="w-full h-40 bg-black border border-zinc-800 text-green-500 text-[10px] p-2 mb-2 font-mono" placeholder="JSON..."></textarea>
        <button onclick="injectData()" class="w-full bg-amber-600 text-black font-bold py-2 text-[10px] uppercase hover:bg-amber-500">Inject & Save</button>
        <button onclick="toggleConsole()" class="mt-2 text-[9px] text-zinc-500 uppercase">Close</button>
    </div>

    <div id="label-float"><div class="cyber-icon-frame"><img id="label-icon" src=""></div><span id="label-text"></span></div>

    <div id="detail-card" class="hidden absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[90%] md:w-[700px] shadow-2xl p-8 text-left" onclick="closeDetail()">
        <button onclick="closeDetail()" class="float-right text-zinc-500 hover:text-white text-2xl">&times;</button>
        <h2 id="card-title" class="text-3xl font-black text-white mb-4 border-l-4 border-amber-500 pl-4"></h2>
        <div class="grid grid-cols-2 gap-8 text-sm">
            <div><p class="text-zinc-500 uppercase text-[10px] mb-1">Source</p><p id="card-who" class="text-white text-lg"></p></div>
            <div><p class="text-zinc-500 uppercase text-[10px] mb-1">Date</p><p id="card-date" class="text-amber-500 font-bold text-lg"></p></div>
        </div>
        <div class="mt-6 p-4 bg-white/5 border border-white/10 text-zinc-300 italic" id="card-desc"></div>
        <p class="mt-4 text-[9px] text-zinc-600 font-mono">TIMESTAMP: <span id="card-stamp" class="text-zinc-400"></span></p>
    </div>

    <script>
        // CONFIG
        const CLOUD_URL = 'https://script.google.com/macros/s/AKfycbwO_yeYQNu22CGFGomksexZ3m4Fk_uS9hd9uzdYYPPQNSM1tky5c-xzlT4PJrQaQojM/exec'; 
        const COLORS = { "üü° SUBSTRAT": "#fbbf24", "üîµ INTELLIGENCE": "#3b82f6", "üî¥ MATRICE": "#ef4444", "üü£ EXTENSION": "#a855f7", "üü¢ VIVANT": "#10b981", "‚ò¢Ô∏è RISQUES": "#f97316", "‚ö™ CONVERGENCE": "#ffffff", "üíó ORACLES": "#f472b6", "DEFAUT": "#9ca3af" };
        const FALLBACK_IMG = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiNmYmJmMjQiIHN0cm9rZS13aWR0aD0iMSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48cmVjdCB4PSIzIiB5PSIzIiB3aWR0aD0iMTgiIGhlaWdodD0iMTgiIHJ4PSIyIiByeT0iMiI+PC9yZWN0Pjwvc3ZnPg==';

        Chart.register(ChartDataLabels);
        let loomChart;

        // UTILS
        const decToDate = v => { const y=Math.floor(v); return `T${Math.floor((v-y)*4)+1} ${y}`; };
        const hexToRgba = (hex, a) => `rgba(${parseInt(hex.slice(1,3),16)},${parseInt(hex.slice(3,5),16)},${parseInt(hex.slice(5,7),16)},${a})`;

        // --- CORE LOGIC ---

        async function loadData(init=false) {
            try {
                const res = await fetch(CLOUD_URL);
                const json = await res.json();
                
                updateChart(json);
                updateRecentUI(json);
                
                const d = new Date();
                const status = document.getElementById('last-sync-status');
                status.innerText = `LIVE: ${("0"+d.getHours()).slice(-2)}:${("0"+d.getMinutes()).slice(-2)}`;
                status.classList.replace('text-zinc-600', 'text-emerald-500');

            } catch(e) { 
                console.error(e); 
                document.getElementById('last-sync-status').innerText = "ERROR";
                document.getElementById('last-sync-status').classList.replace('text-zinc-600', 'text-red-500');
            } finally { 
                if(init) {
                    document.getElementById('loading-overlay').style.opacity = 0; 
                    setTimeout(()=>document.getElementById('loading-overlay').remove(), 500); 
                }
            }
        }

        function updateChart(flatData) {
            const strands = {};
            flatData.sort((a,b) => a.year - b.year);
            flatData.forEach(d => {
                let c = d.category || "DEFAUT";
                if(!COLORS[c]) c = Object.keys(COLORS).find(k=>k.includes(c)) || "DEFAUT";
                if(!strands[c]) strands[c] = { label: c, borderColor: COLORS[c], backgroundColor: COLORS[c], data: [] };
                strands[c].data.push({ x: d.year, y: d.value, ...d });
            });

            loomChart.data.datasets = Object.values(strands);
            loomChart.update('none');
        }

        // --- LOGIQUE ACTIVIT√â R√âCENTE (12H) ---
        function updateRecentUI(data) {
            const now = new Date();
            const twelveHoursAgo = new Date(now.getTime() - (12 * 60 * 60 * 1000));
            
            // Filtre strict sur timestamp valide > 12h
            const recentItems = data.filter(d => {
                if (!d.timestamp) return false;
                return new Date(d.timestamp) > twelveHoursAgo;
            });

            const count = recentItems.length;
            document.getElementById('recent-meta').innerHTML = `<span class="text-white font-bold">${count}</span> √©l√©ments ajout√©s`;
            
            const list = document.getElementById('recent-list');
            list.innerHTML = '';
            
            if (count === 0) {
                list.innerHTML = '<li class="text-zinc-600 italic text-[9px]">Aucune activit√© (12h).</li>';
            } else {
                recentItems.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
                recentItems.forEach(item => {
                    const li = document.createElement('li');
                    const color = COLORS[item.category] || '#fff';
                    const diffMs = now - new Date(item.timestamp);
                    const diffHrs = Math.floor(diffMs / (1000 * 60 * 60));
                    const timeTag = diffHrs < 1 ? "New" : `-${diffHrs}h`;
                    
                    li.innerHTML = `<span style="color:${color}">‚óè</span> <span class="text-zinc-500 text-[8px]">[${timeTag}]</span> ${item.label}`;
                    list.appendChild(li);
                });
            }
        }

        // --- INTERACTIONS ---
        async function injectData() {
            const txt = document.getElementById('json-paste').value;
            if(!txt) return;
            try {
                const json = JSON.parse(txt);
                // Si injection manuelle, on force le timestamp si absent pour qu'il apparaisse dans "Recent"
                const nowIso = new Date().toISOString();
                json.forEach(item => { if(!item.timestamp) item.timestamp = nowIso; });
                
                await fetch(CLOUD_URL, { method:'POST', body:JSON.stringify(json) });
                alert("Donn√©es envoy√©es.");
                loadData();
            } catch(e) { alert("Erreur JSON"); }
        }

        function showDetail(d) {
            document.getElementById('card-title').innerText = d.label;
            document.getElementById('card-who').innerText = d.whoWhat || "N/A";
            document.getElementById('card-date').innerText = decToDate(d.x);
            document.getElementById('card-desc').innerText = d.description || d.how || "";
            document.getElementById('card-stamp').innerText = d.timestamp || "ARCHIVE";
            document.getElementById('detail-card').classList.remove('hidden');
        }
        function closeDetail() { document.getElementById('detail-card').classList.add('hidden'); }
        function toggleConsole() { const c=document.getElementById('sync-console'); c.style.display=c.style.display==='flex'?'none':'flex'; }
        function resetToModern() { loomChart.options.scales.x.min=1960; loomChart.options.scales.x.max=2040; loomChart.update(); }

        // --- INIT ---
        window.onload = () => {
            const ctx = document.getElementById('loomChart');
            loomChart = new Chart(ctx, {
                type: 'line',
                data: { datasets: [] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    // PADDING CRITIQUE : Gauche 230px pour la sidebar, Droite 50px
                    layout: { padding: { left: 230, right: 50, top: 20, bottom: 20 } },
                    scales: {
                        x: { type: 'linear', min: 1960, max: 2040, grid: { color: '#222' }, ticks: { color: '#666', callback: decToDate } },
                        y: { type: 'logarithmic', position: 'right', grid: { color: '#111' } }
                    },
                    plugins: {
                        legend: { position: 'left', align: 'start', labels: { color: '#888', boxWidth: 10, padding: 15, font: {size: 10} } },
                        datalabels: { 
                            color: '#fff', align: 'top', offset: 20, 
                            backgroundColor: ctx => hexToRgba(ctx.dataset.borderColor, 0.8),
                            borderRadius: 2, padding: 4, font: { size: 10, weight: 'bold' },
                            formatter: v => v.label,
                            clip: false, // Permet aux √©tiquettes de d√©border un peu
                            listeners: { click: c => showDetail(c.dataset.data[c.dataIndex]) }
                        },
                        zoom: { zoom: { wheel: { enabled: true }, mode: 'x' }, pan: { enabled: true, mode: 'xy' } }
                    },
                    onHover: (e, el) => {
                        const f = document.getElementById('label-float'), img = document.getElementById('label-icon');
                        if (el.length > 0) {
                            const d = loomChart.data.datasets[el[0].datasetIndex].data[el[0].index];
                            f.style.display = 'flex'; f.style.left = (e.x + 15) + 'px'; f.style.top = (e.y - 15) + 'px';
                            document.getElementById('label-text').innerText = d.label; img.src = d.img || FALLBACK_IMG;
                        } else f.style.display = 'none';
                    }
                }
            });
            loadData(true);
            setInterval(() => loadData(false), 300000); // 5 min
        };
    </script>
</body>
</html>
