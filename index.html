<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>THE LOOM : EXOCORTEX v100 (Phoenix)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&family=Inter:wght@300;400;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root { --bg: #010102; --accent: #fbbf24; }
        html, body { 
            margin: 0; padding: 0; width: 100vw; height: 100dvh; 
            background-color: var(--bg); overflow: hidden; position: fixed; inset: 0; 
            font-family: 'JetBrains Mono', monospace; color: white; user-select: none;
        }

        /* HEADER */
        header { 
            position: absolute; top: 0; left: 0; width: 100%; height: 40px;
            background: rgba(0,0,0,0.9); border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex; justify-content: space-between; align-items: center; padding: 0 1rem; z-index: 50;
        }

        /* CANVAS */
        #viewport { position: absolute; inset: 0; z-index: 1; }
        canvas { display: block; width: 100%; height: 100%; }

        /* OVERLAY GAUCHE (FLUX ENTRANT) */
        /* Positionn√© par-dessus le canvas, dans la zone de padding gauche du graph */
        #overlay-sidebar {
            position: absolute; top: 50px; left: 10px; width: 220px;
            pointer-events: none; /* Laisse passer les clics vers le graph en dessous */
            z-index: 10; display: flex; flex-direction: column; gap: 20px;
        }

        #recent-block {
            pointer-events: auto; /* R√©active les clics pour le scroll */
            background: rgba(10, 10, 15, 0.85); border: 1px solid rgba(255,255,255,0.1); border-left: 2px solid var(--accent);
            padding: 10px; backdrop-filter: blur(4px);
        }
        #recent-title { font-size: 10px; color: var(--accent); font-weight: 800; text-transform: uppercase; margin-bottom: 4px; display: flex; justify-content: space-between; }
        #timer-badge { color: #10b981; }
        #recent-list { max-height: 200px; overflow-y: auto; list-style: none; padding: 0; margin: 0; }
        #recent-list li { font-size: 9px; color: #ccc; margin-bottom: 4px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 2px; }

        /* MODALS & CONSOLE */
        #sync-console { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            width: 400px; background: #08080c; border: 1px solid var(--accent); 
            display: none; flex-direction: column; padding: 1.5rem; z-index: 6000; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.9);
        }
        #upload-ticker {
            height: 20px; margin-top: 10px; font-size: 10px; color: var(--accent); 
            font-weight: bold; overflow: hidden; white-space: nowrap; text-align: center;
        }
        
        #loading-screen { position: fixed; inset: 0; background: #000; z-index: 9000; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #666; transition: opacity 0.5s; }
        
        #detail-card { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90%; max-width: 600px; background: rgba(5,5,8,0.98); 
            border: 1px solid #333; padding: 2rem; z-index: 5000; display: none;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }

        .hud-btn { @apply text-zinc-500 text-[9px] hover:text-white uppercase font-black transition-all cursor-pointer; }
    </style>
</head>
<body>

    <div id="loading-screen">INITIALISATION V100...</div>

    <header>
        <h1 class="text-[10px] font-black tracking-[0.2em] uppercase text-zinc-500 italic">The Loom <span class="text-amber-500">v100</span></h1>
        <div class="flex items-center gap-4">
            <span id="sync-status" class="text-[9px] font-bold text-zinc-600">OFFLINE</span>
            <button onclick="resetView()" class="hud-btn">Reset 1985</button>
            <button onclick="toggleConsole()" class="hud-btn text-amber-500 border border-amber-500/30 px-2 py-0.5 rounded hover:bg-amber-500/10">INJECT DATA</button>
        </div>
    </header>

    <div id="viewport">
        <canvas id="loomChart"></canvas>
    </div>

    <div id="overlay-sidebar">
        <div id="recent-block">
            <div id="recent-title">
                <span>Flux Entrant</span>
                <span id="timer-badge">--:--</span>
            </div>
            <ul id="recent-list" class="scrollbar-thin">
                <li class="italic text-zinc-600">En attente...</li>
            </ul>
        </div>
    </div>

    <div id="sync-console">
        <h3 class="text-amber-500 font-bold text-xs mb-2 uppercase">Injection JSON</h3>
        <textarea id="json-paste" class="w-full h-32 bg-black border border-zinc-800 text-green-500 text-[10px] p-2 mb-4 font-mono outline-none" placeholder='[{"year": 2025, "label": "Test"}]'></textarea>
        
        <button onclick="executeInjection()" id="btn-inject" class="w-full bg-amber-600 text-black font-bold py-3 text-[10px] uppercase hover:bg-amber-500 transition-colors">
            LANCER L'UPLOAD
        </button>
        
        <div id="upload-ticker"></div>
        
        <button onclick="toggleConsole()" class="mt-4 text-[9px] text-zinc-600 uppercase hover:text-white text-center w-full">Annuler</button>
    </div>

    <div id="detail-card">
        <button onclick="closeDetail()" class="absolute top-4 right-4 text-zinc-500 hover:text-white text-2xl">&times;</button>
        <h2 id="card-title" class="text-2xl font-black text-white mb-2 text-amber-500 uppercase"></h2>
        <div class="flex gap-4 text-[10px] text-zinc-500 uppercase mb-4 border-b border-zinc-800 pb-2">
            <span>Source: <b id="card-who" class="text-zinc-300"></b></span>
            <span>Date: <b id="card-date" class="text-zinc-300"></b></span>
        </div>
        <p id="card-desc" class="text-zinc-300 italic text-sm leading-relaxed"></p>
        <div class="mt-4 text-[9px] text-zinc-700 font-mono">ID: <span id="card-stamp"></span></div>
    </div>

    <script>
        const CLOUD_URL = 'https://script.google.com/macros/s/AKfycbwO_yeYQNu22CGFGomksexZ3m4Fk_uS9hd9uzdYYPPQNSM1tky5c-xzlT4PJrQaQojM/exec'; 
        const COLORS = { "üü° SUBSTRAT": "#fbbf24", "üîµ INTELLIGENCE": "#3b82f6", "üî¥ MATRICE": "#ef4444", "üü£ EXTENSION": "#a855f7", "üü¢ VIVANT": "#10b981", "‚ò¢Ô∏è RISQUES": "#f97316", "‚ö™ CONVERGENCE": "#ffffff", "üíó ORACLES": "#f472b6", "DEFAUT": "#9ca3af" };

        Chart.register(ChartDataLabels);
        let loomChart;

        // UTILS
        const decToDate = v => { 
            if(v < 0) return Math.floor(v); // Antiquit√© simple
            const y=Math.floor(v); return `T${Math.floor((v-y)*4)+1} ${y}`; 
        };
        const hexToRgba = (hex, a) => {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? `rgba(${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}, ${a})` : `rgba(100,100,100,${a})`;
        };

        // --- CORE LOGIC ---

        async function loadData(init = false) {
            try {
                const res = await fetch(CLOUD_URL);
                const json = await res.json();
                
                if(!Array.isArray(json)) throw new Error("Format Invalide");

                updateChart(json);
                updateRecentFlux(json);

                // SMART FOCUS LOGIC (Comme V99 mais s√©curis√©)
                if (init) {
                    const now = new Date();
                    const limit = new Date(now.getTime() - (12 * 60 * 60 * 1000));
                    // Cherche un event r√©cent avec un timestamp valide
                    const recent = json.filter(d => d.timestamp && new Date(d.timestamp) > limit);
                    
                    if (recent.length > 0) {
                        recent.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
                        const focusYear = recent[0].year;
                        loomChart.options.scales.x.min = focusYear - 5;
                        loomChart.options.scales.x.max = focusYear + 5;
                        console.log("Focus Actu:", focusYear);
                    } else {
                        // Pas d'actu -> Focus 1985
                        loomChart.options.scales.x.min = 1945;
                        loomChart.options.scales.x.max = 2025;
                    }
                    loomChart.update();
                }

                // Update Status
                const d = new Date();
                const st = document.getElementById('sync-status');
                st.innerText = `SYNC ${("0"+d.getHours()).slice(-2)}:${("0"+d.getMinutes()).slice(-2)}`;
                st.className = 'text-[9px] font-bold text-emerald-500';

            } catch (e) {
                console.error(e);
                const st = document.getElementById('sync-status');
                st.innerText = "ERROR";
                st.className = 'text-[9px] font-bold text-red-500';
            } finally {
                if(init) {
                    const ls = document.getElementById('loading-screen');
                    ls.style.opacity = 0;
                    setTimeout(() => ls.remove(), 500);
                }
            }
        }

        function updateChart(flatData) {
            // Regroupement par cat√©gorie pour Chart.js (Format V93)
            const strands = {};
            flatData.sort((a,b) => a.year - b.year);
            
            flatData.forEach(d => {
                let c = d.category || "DEFAUT";
                // Matching approximatif des couleurs
                if(!COLORS[c]) c = Object.keys(COLORS).find(k => k.includes(c)) || "DEFAUT";
                
                if(!strands[c]) {
                    strands[c] = {
                        label: c, // IMPORTANT: C'est ce qui s'affiche dans la l√©gende Chart.js
                        borderColor: COLORS[c],
                        backgroundColor: COLORS[c],
                        data: [],
                        pointRadius: 4,
                        hitRadius: 10,
                        tension: 0.3
                    };
                }
                strands[c].data.push({ x: d.year, y: d.value, ...d });
            });

            loomChart.data.datasets = Object.values(strands);
            loomChart.update('none'); // Update sans animation pour fluidit√©
        }

        function updateRecentFlux(data) {
            const now = new Date();
            const limit = new Date(now.getTime() - (12 * 60 * 60 * 1000)); // 12h
            
            const recent = data.filter(d => d.timestamp && new Date(d.timestamp) > limit)
                               .sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));

            const list = document.getElementById('recent-list');
            list.innerHTML = '';
            
            if (recent.length === 0) {
                list.innerHTML = '<li class="italic text-zinc-600">R.A.S (12h)</li>';
                return;
            }

            recent.forEach(item => {
                const li = document.createElement('li');
                const col = COLORS[item.category] || '#fff';
                // Calcul temps
                const mins = Math.floor((now - new Date(item.timestamp))/60000);
                const timeStr = mins < 60 ? `${mins}m` : `${Math.floor(mins/60)}h`;
                
                li.innerHTML = `<span style="color:${col}">‚óè</span> <span class="text-zinc-500 text-[8px] mr-1">${timeStr}</span> ${item.label}`;
                list.appendChild(li);
            });
        }

        // --- INJECTION ENGINE ---
        async function executeInjection() {
            const txt = document.getElementById('json-paste').value;
            const btn = document.getElementById('btn-inject');
            const ticker = document.getElementById('upload-ticker');
            
            if(!txt) return;

            try {
                const json = JSON.parse(txt);
                const now = new Date().toISOString();
                
                // Pr√©paration Donn√©es
                json.forEach(i => { if(!i.timestamp) i.timestamp = now; });
                
                // UI Feedback - Animation Ticker
                btn.disabled = true;
                btn.innerText = "UPLOADING...";
                btn.classList.add('opacity-50');
                
                // Simulation du d√©filement des noms
                let idx = 0;
                const tickerInterval = setInterval(() => {
                    if(idx >= json.length) idx = 0;
                    ticker.innerText = `Sending: ${json[idx].label}...`;
                    idx++;
                }, 150);

                // ENVOI REEL
                await fetch(CLOUD_URL, { 
                    method:'POST', 
                    body:JSON.stringify(json) 
                });

                // CLEANUP
                clearInterval(tickerInterval);
                ticker.innerText = "SUCCESS!";
                
                // Fermeture & Refresh
                setTimeout(() => {
                    toggleConsole();
                    loadData(true); // Re-focus sur le nouvel event
                    // Reset UI
                    btn.disabled = false;
                    btn.innerText = "LANCER L'UPLOAD";
                    btn.classList.remove('opacity-50');
                    document.getElementById('json-paste').value = "";
                    ticker.innerText = "";
                }, 1000);

            } catch(e) {
                alert("Erreur: " + e.message);
                btn.disabled = false;
                btn.innerText = "RETRY";
                btn.classList.remove('opacity-50');
            }
        }

        // --- TIMER ---
        function updateCountdown() {
            const now = new Date();
            const targets = [8, 20].map(h => {
                const d = new Date(now); d.setUTCHours(h,0,0,0);
                if(d < now) d.setDate(d.getDate()+1);
                return d;
            }).sort((a,b) => a-b);
            
            const diff = targets[0] - now;
            const h = Math.floor(diff/3600000);
            const m = Math.floor((diff%3600000)/60000);
            document.getElementById('timer-badge').innerText = `${h}h${m}`;
        }

        // --- UI & INIT ---
        function toggleConsole() { 
            const c = document.getElementById('sync-console'); 
            c.style.display = c.style.display==='flex' ? 'none' : 'flex'; 
        }
        function showDetail(d) {
            document.getElementById('card-title').innerText = d.label;
            document.getElementById('card-who').innerText = d.whoWhat || "?";
            document.getElementById('card-date').innerText = decToDate(d.x);
            document.getElementById('card-desc').innerText = d.description || d.how || "";
            document.getElementById('card-stamp').innerText = d.timestamp || "ARCHIVE";
            document.getElementById('detail-card').style.display = 'block';
        }
        function closeDetail() { document.getElementById('detail-card').style.display = 'none'; }
        function resetView() { loomChart.options.scales.x.min=1945; loomChart.options.scales.x.max=2025; loomChart.update(); }

        window.onload = () => {
            const ctx = document.getElementById('loomChart');
            
            loomChart = new Chart(ctx, {
                type: 'line',
                data: { datasets: [] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    // PADDING GAUCHE : On laisse 240px pour l'overlay et la l√©gende native
                    layout: { padding: { left: 240, right: 50, top: 20, bottom: 20 } },
                    scales: {
                        x: { type: 'linear', min: 1945, max: 2025, grid: { color: '#222' }, ticks: { color: '#666', callback: decToDate } },
                        y: { type: 'logarithmic', position: 'right', grid: { color: '#111' } }
                    },
                    plugins: {
                        // LE RETOUR DE LA L√âGENDE NATIVE (Positions V93)
                        legend: { 
                            display: true, position: 'left', align: 'start',
                            labels: { color: '#888', font: { size: 10 }, boxWidth: 10, padding: 10 }
                        },
                        datalabels: { 
                            color: '#fff', align: 'top', offset: 12, 
                            backgroundColor: ctx => hexToRgba(ctx.dataset.borderColor, 0.8),
                            borderRadius: 2, padding: 4, font: { size: 9, weight: 'bold' },
                            formatter: v => v.label, clip: false,
                            listeners: { click: c => showDetail(c.dataset.data[c.dataIndex]) }
                        },
                        zoom: { zoom: { wheel: { enabled: true }, mode: 'x' }, pan: { enabled: true, mode: 'xy' } }
                    }
                }
            });
            
            loadData(true);
            setInterval(() => loadData(false), 300000); // 5 min
            setInterval(updateCountdown, 60000); // 1 min
            updateCountdown();
        };
    </script>
</body>
</html>
