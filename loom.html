<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>THE LOOM : EXOCORTEX v77</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;800&family=Inter:wght@300;400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #010102; --accent: #fbbf24; }
        html, body { 
            margin: 0 !important; padding: 0 !important; 
            width: 100vw !important; height: 100dvh !important; 
            background-color: var(--bg) !important; overflow: hidden !important;
            position: fixed; inset: 0; font-family: 'JetBrains Mono', monospace;
        }
        #viewport { position: absolute; inset: 0; display: flex; flex-direction: column; width: 100%; height: 100%; }
        header { 
            position: absolute; top: 0; left: 0; width: 100%; height: 50px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.9) 0%, transparent 100%);
            display: flex; justify-content: space-between; align-items: center; 
            padding: 0 1rem; z-index: 1000; pointer-events: none;
        }
        .hud-element { pointer-events: auto; }
        .canvas-container { flex: 1; position: relative; width: 100%; height: 100%; overflow: hidden; z-index: 1; }
        
        /* FORÇAGE DU CURSEUR */
        canvas { width: 100% !important; height: 100% !important; display: block; cursor: crosshair; }
        .is-pointer { cursor: pointer !important; }

        #sync-console {
            position: fixed; top: 60px; right: 20px; width: 340px;
            background: rgba(5, 5, 10, 0.98); border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(30px); z-index: 6000; padding: 1.5rem; 
            display: none; flex-direction: column; border-radius: 4px;
        }
        .cyber-icon-frame { border: 1px solid var(--accent); background: #111; overflow: hidden; }
        #label-float { 
            position: fixed; pointer-events: none; background: rgba(0,0,0,0.95); border: 1px solid var(--accent); 
            color: #fff; padding: 6px 12px; font-size: 11px; font-weight: 700; border-radius: 2px; 
            z-index: 4000; display: none; align-items: center; gap: 10px;
        }
        .detail-modal { background: rgba(4, 4, 6, 0.98); backdrop-filter: blur(50px); border: 1px solid rgba(255,255,255,0.1); z-index: 5000; }
    </style>
</head>
<body>

    <div id="viewport">
        <header>
            <h1 class="text-[10px] font-black tracking-[0.3em] uppercase text-zinc-500 italic">The Loom <span class="text-amber-500 font-bold">v77</span></h1>
            <div class="flex gap-4">
                <button onclick="resetToCenter()" class="hud-element text-zinc-500 text-[9px] hover:text-white uppercase font-black transition-all">Initial Focus</button>
                <button onclick="toggleSyncConsole()" class="hud-element px-3 py-1.5 bg-amber-500/10 text-amber-500 text-[9px] font-black border border-amber-500/30 uppercase rounded-sm hover:bg-amber-500 hover:text-black transition-all">Sync Console</button>
            </div>
        </header>

        <main class="canvas-container" onclick="closeAll()">
            <canvas id="loomChart"></canvas>
        </main>
    </div>

    <div id="sync-console">
        <h3 class="text-[10px] font-black text-amber-500 uppercase mb-4 text-left">// Data Injection</h3>
        <div class="space-y-4">
            <input type="file" id="fileInput" accept=".json" onchange="handleFileUpload(this)" class="w-full text-[9px] text-zinc-400 bg-white/5 border border-white/10 p-2 file:hidden cursor-pointer">
            <textarea id="json-paste" placeholder='{"strands": [...] }' class="w-full h-40 bg-black/50 border border-white/10 text-amber-200/70 p-3 font-mono text-[10px] outline-none resize-none"></textarea>
            <button onclick="syncFromText()" class="w-full py-3 bg-white text-black text-[10px] font-black uppercase hover:bg-amber-500">Inject Data</button>
        </div>
        <button onclick="toggleSyncConsole()" class="mt-4 text-[9px] text-zinc-600 uppercase font-bold hover:text-zinc-400">Close</button>
    </div>

    <div id="label-float"><div class="cyber-icon-frame"><img id="label-icon" src="" class="w-8 h-8 object-cover" onerror="imgError(this)"></div><span id="label-text"></span></div>

    <div id="detail-card" class="hidden absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[95%] md:w-[850px] detail-modal flex flex-col shadow-2xl rounded-sm" onclick="event.stopPropagation()">
        <div class="p-8 md:p-12 overflow-y-auto max-h-[85vh] text-white text-left">
            <button onclick="closeDetail()" class="float-right text-zinc-500 hover:text-white text-4xl">&times;</button>
            <div class="flex items-start gap-6 mb-8">
                <div class="cyber-icon-frame hidden md:block shrink-0"><img id="card-icon" src="" class="w-20 h-20 object-cover" onerror="imgError(this)"></div>
                <h2 id="card-title" class="text-3xl md:text-5xl font-black border-l-4 border-amber-500 pl-6 uppercase italic leading-tight"></h2>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                <div class="space-y-8">
                    <section><h4 class="text-zinc-500 font-black uppercase text-[10px] mb-2 opacity-50">// Origine</h4><p id="card-who-what" class="text-zinc-100 text-xl font-light"></p></section>
                    <section><h4 class="text-zinc-500 font-black uppercase text-[10px] mb-2 opacity-50">// Temporalité</h4><p id="card-when" class="text-amber-500 font-bold text-xl italic"></p></section>
                </div>
                <section class="bg-white/5 p-8 border border-white/5">
                    <h4 class="text-zinc-500 font-black uppercase text-[10px] mb-4 opacity-50">// Analyse Stratégique</h4>
                    <p id="card-how" class="text-zinc-300 italic text-base leading-relaxed"></p>
                    <div id="link-area" class="mt-10 hidden"><button id="jump-btn" class="w-full py-5 bg-white text-black text-[10px] font-black uppercase hover:bg-amber-500 transition-all shadow-xl"></button></div>
                </section>
            </div>
        </div>
    </div>

    <script>
        const LOCAL_DATA_URL = 'loom_data.json';
        const FALLBACK_IMG = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiNmYmJmMjQiIHN0cm9rZS13aWR0aD0iMSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48cmVjdCB4PSIzIiB5PSIzIiB3aWR0aD0iMTgiIGhlaWdodD0iMTgiIHJ4PSIyIiByeT0iMiI+PC9yZWN0PjxsaW5lIHgxPSIzIiB5MT0iOSIgeDI9IjIxIiB5Mj0iOSI+PC9saW5lPjxsaW5lIHgxPSI5IiB5MT0iMjEiIHgyPSI5IiB5Mj0iOSI+PC9saW5lPjwvc3ZnPg==';
        Chart.register(ChartDataLabels);

        let loomChart, currentData = { strands: [] };

        const hexToRgba = (hex, a) => {
            if(!hex || hex[0] !== '#') return `rgba(251,191,36,${a})`;
            const r = parseInt(hex.slice(1,3), 16), g = parseInt(hex.slice(3,5), 16), b = parseInt(hex.slice(5,7), 16);
            return `rgba(${r},${g},${b},${a})`;
        };

        const decimalToDate = (v) => {
            const y = Math.floor(v), f = v - y;
            return f < 0.05 ? y.toString() : `T${Math.floor(f * 4) + 1} ${y}`;
        };

        function imgError(image) { image.onerror = null; image.src = FALLBACK_IMG; image.style.opacity = "0.5"; }
        function toggleSyncConsole() { const el = document.getElementById('sync-console'); el.style.display = (el.style.display === 'flex') ? 'none' : 'flex'; }
        function closeAll() { closeDetail(); document.getElementById('sync-console').style.display = 'none'; }
        function resetToCenter() {
            if (!loomChart) return;
            loomChart.options.scales.x.min = 1935; loomChart.options.scales.x.max = 2030;
            loomChart.options.scales.y.min = 1; loomChart.options.scales.y.max = 1000000000;
            loomChart.update('none');
        }

        function updateChart(json) {
            currentData = json;
            loomChart.data.datasets = json.strands.map(s => ({
                label: s.name,
                data: s.events.filter(e => e.label && e.label !== "undefined").map(e => ({ 
                    x: e.year, y: e.value, label: e.label, whoWhat: e.whoWhat || e.author, how: e.how || e.pitch, img: e.img, realYear: e.realYear 
                })),
                borderColor: s.color, backgroundColor: s.color, tension: 0.3, pointRadius: 4, hitRadius: 20
            }));
            loomChart.update();
        }

        async function loadFromLocal() {
            try {
                const res = await fetch(LOCAL_DATA_URL);
                const json = await res.json();
                updateChart(json);
                setTimeout(resetToCenter, 500);
            } catch (e) { 
                console.error("Local data loading error. Is loom_data.json present and valid?", e);
                alert("ERREUR : Impossible de charger loom_data.json. Vérifiez la console pour plus de détails.");
            }
        }

        function handleFileUpload(input) {
            const reader = new FileReader();
            reader.onload = (e) => { try { updateChart(JSON.parse(e.target.result)); toggleSyncConsole(); } catch(err){alert("JSON Error");}};
            reader.readAsText(input.files[0]);
        }

        function syncFromText() {
            try { updateChart(JSON.parse(document.getElementById('json-paste').value)); toggleSyncConsole(); } catch(err){alert("Parsing Error");}
        }

        function showDetail(d) {
            document.getElementById('card-title').innerText = d.label;
            document.getElementById('card-who-what').innerText = d.whoWhat || "N/A";
            document.getElementById('card-when').innerText = decimalToDate(d.x);
            document.getElementById('card-how').innerText = d.how || "Analyse attendue...";
            document.getElementById('card-icon').src = d.img || FALLBACK_IMG;
            const area = document.getElementById('link-area'), btn = document.getElementById('jump-btn');
            if (d.realYear) {
                area.classList.remove('hidden');
                btn.innerText = `Focus Temporel : ${decimalToDate(d.realYear)}`;
                btn.onclick = () => jumpToTarget(d.realYear);
            } else area.classList.add('hidden');
            document.getElementById('detail-card').classList.remove('hidden');
        }

        function jumpToTarget(targetYear) {
            closeDetail();
            loomChart.zoomScale('x', { min: targetYear - 0.4, max: targetYear + 0.4 }, 'easeOutQuart'); 
            let targetEvent = null;
            currentData.strands.forEach(s => {
                const found = s.events.find(e => e.year === targetYear);
                if (found) targetEvent = {...found, x: found.year, y: found.value};
            });
            if (targetEvent) setTimeout(() => showDetail(targetEvent), 600);
        }

        function closeDetail() { document.getElementById('detail-card').classList.add('hidden'); }

        const chartConfig = {
            type: 'line', data: { datasets: [] },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: {
                    x: { type: 'linear', ticks: { color: '#444' }, grid: { color: '#111' } },
                    y: { type: 'logarithmic', position: 'right', ticks: { color: '#222' }, grid: { color: '#080808' } }
                },
                plugins: {
                    legend: { display: true, position: 'top', align: 'end', labels: { color: '#555', font: { size: 8 } } },
                    tooltip: { enabled: false },
                    zoom: { zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'xy' }, pan: { enabled: true, mode: 'xy' } },
                    datalabels: {
                        display: (ctx) => ctx.dataset.data[ctx.dataIndex].label ? true : false,
                        color: '#fff', align: (ctx) => ctx.dataIndex % 2 === 0 ? 'top' : 'bottom',
                        offset: 35, backgroundColor: (ctx) => hexToRgba(ctx.dataset.borderColor, 0.7),
                        borderRadius: 2, padding: 6, font: { size: 9, weight: 'bold' },
                        formatter: (v) => v.label ? v.label.toUpperCase() : '',
                        listeners: { 
                            click: (ctx) => showDetail(ctx.dataset.data[ctx.dataIndex]),
                            enter: (ctx) => { ctx.chart.canvas.classList.add('is-pointer'); return true; },
                            leave: (ctx) => { ctx.chart.canvas.classList.remove('is-pointer'); return true; }
                        }
                    }
                },
                onHover: (e, el) => {
                    const f = document.getElementById('label-float'), img = document.getElementById('label-icon');
                    const canvas = e.chart.canvas;
                    if (el.length > 0) {
                        const d = loomChart.data.datasets[el[0].datasetIndex].data[el[0].index];
                        f.style.display = 'flex'; f.style.left = (e.x + 15) + 'px'; f.style.top = (e.y - 15) + 'px';
                        document.getElementById('label-text').innerText = d.label;
                        img.src = d.img || FALLBACK_IMG;
                        canvas.classList.add('is-pointer');
                    } else {
                        // On ne retire le curseur que si aucune étiquette n'a pris le relais
                        f.style.display = 'none';
                        canvas.classList.remove('is-pointer');
                    }
                }
            },
            plugins: [{
                id: 'finalCallouts',
                afterDraw: (chart) => {
                    const ctx = chart.ctx; ctx.save();
                    chart.data.datasets.forEach((ds, dsIdx) => {
                        const meta = chart.getDatasetMeta(dsIdx);
                        if (meta.hidden) return;
                        meta.data.forEach((point, i) => {
                            ctx.beginPath(); ctx.setLineDash([2, 2]); ctx.lineWidth = 1; ctx.strokeStyle = 'rgba(255,255,255,0.2)';
                            ctx.moveTo(point.x, point.y); ctx.lineTo(point.x, i % 2 === 0 ? point.y - 30 : point.y + 30);
                            ctx.stroke();
                        });
                    });
                    ctx.restore();
                }
            }]
        };

        window.onload = () => {
            const canvas = document.getElementById('loomChart');
            loomChart = new Chart(canvas, chartConfig);
            loadFromLocal();
            
            // FORÇAGE SUPPLÉMÉMENTAIRE POUR LES ÉTIQUETTES
            canvas.addEventListener('mousemove', (e) => {
                const head = loomChart.getElementsAtEventForMode(e, 'nearest', { intersect: true }, false);
                if (head.length > 0) canvas.classList.add('is-pointer');
            });

            new ResizeObserver(() => loomChart.resize()).observe(document.body);
        };
    </script>
</body>
</html>